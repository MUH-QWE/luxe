<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Checkout - LUXE Fashion</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/Checkout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body data-page="checkout">

    <header id="main-header">
        <div class="container">
            <div class="logo"><i class="fas fa-crown"></i><span>LUXE</span></div>
            <nav id="navbar-links">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="Products.html">Products</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div class="cart-icon" data-link="Cart.html">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="cart-count" id="cart-count">0</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container" id="checkout-page">
        <div class="checkout-progress">
            <div class="progress-step active">
                <div class="step-number">1</div>
                <span class="step-label">Shipping</span>
            </div>
            <div class="progress-step">
                <div class="step-number">2</div>
                <span class="step-label">Payment</span>
            </div>
            <div class="progress-step">
                <div class="step-number">3</div>
                <span class="step-label">Confirmation</span>
            </div>
        </div>

        <div class="checkout-content">
            <div class="checkout-forms">
                <form id="checkout-form">

                    <div class="form-section">
                        <h3>Contact Information</h3>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="email" required placeholder="example@email.com">
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="phone" required placeholder="+20 123 456 7890">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Shipping Address</h3>
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="fullname" required>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="address" required placeholder="Street address, apartment, etc.">
                        </div>
                        <button type="button" class="btn-primary" id="btn-location">Use Current Location</button>
                    </div>

                    <div class="form-section payment-method-section">
                        <h3>Payment Method</h3>
                        <div class="payment-option">
                            <input type="radio" name="payment" id="payment-cash" value="cash" checked>
                            <label for="payment-cash">Cash on Delivery (COD)</label>
                        </div>
                        <div class="payment-option">
                            <input type="radio" name="payment" id="payment-wallet" value="wallet">
                            <label for="payment-wallet">Wallet Payment (Vodafone Cash)</label>
                        </div>

                        <!-- الرقم للتحويل يظهر قبل رفع الصورة -->
                        <div class="wallet-info" style="display:none; margin-top:10px;">
                            <p>Transfer to this number: <strong id="wallet-number">+201234567890</strong></p>
                        </div>

                        <div class="wallet-upload" style="margin-top:10px; display:none;">
                            <label for="wallet-receipt" style="color:#8fe4ff;">Upload Payment Screenshot:</label>
                            <input type="file" id="wallet-receipt" accept="image/*">
                            <p style="color:#aaa; font-size:0.85rem; margin-top:4px;">Upload a photo of your wallet
                                transfer.</p>
                        </div>
                    </div>

                    <div class="form-errors" id="form-errors" style="color:red; margin-top:10px;"></div>

                </form>
            </div>

            <div class="order-summary-box">
                <h3>Order Summary</h3>
                <div id="checkout-items-preview"></div>
                <div class="summary-totals">
                    <div class="row"><span>Subtotal</span><span id="checkout-subtotal">$0.00</span></div>
                    <div class="row"><span>Shipping</span><span id="checkout-shipping">$0.00</span></div>
                    <div class="row total"><span>Total</span><span id="checkout-total">$0.00</span></div>
                </div>
            </div>

            <div class="btn-container">
                <button type="submit" class="btn-primary">Place Order</button>
            </div>

        </div>
    </div>

    <footer id="main-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo"><i class="fas fa-crown"></i><span>LUXE</span></div>
                    <p>Premium fashion for the modern individual. Quality, style, and elegance in every piece.</p>
                </div>
                <div class="footer-section">
                    <h3>Quick Links</h3>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="Products.html">Shop</a></li>
                        <li><a href="Cart.html">Cart</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="js/ALL.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            LuxeApp.updateCartUI?.();

            if (!LuxeApp.state.user || !LuxeApp.state.cart || LuxeApp.state.cart.length === 0) {
                alert('Your cart is empty or you are not logged in.');
                window.location.href = 'Products.html';
                return;
            }

            const emailInput = document.getElementById('email');
            if (LuxeApp.state.user?.email) emailInput.value = LuxeApp.state.user.email;

            const checkoutItems = document.getElementById('checkout-items-preview');
            const subtotalEl = document.getElementById('checkout-subtotal');
            const shippingEl = document.getElementById('checkout-shipping');
            const totalEl = document.getElementById('checkout-total');
            const formErrors = document.getElementById('form-errors');

            let subtotal = 0;
            LuxeApp.state.cart.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checkout-item';
                div.innerHTML = `<span>${item.name} x ${item.quantity}</span><span>$${(item.price * item.quantity).toFixed(2)}</span>`;
                checkoutItems.appendChild(div);
                subtotal += item.price * item.quantity;
            });
            subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            shippingEl.textContent = `$0.00`;
            totalEl.textContent = `$${subtotal.toFixed(2)}`;

            // ===== Wallet logic =====
            const walletUpload = document.querySelector('.wallet-upload');
            const walletInfo = document.querySelector('.wallet-info');
            const paymentCash = document.getElementById('payment-cash');
            const paymentWallet = document.getElementById('payment-wallet');
            const walletNumber = document.getElementById('wallet-number');

            function toggleWallet() {
                if (paymentWallet.checked) {
                    walletInfo.style.display = 'block';
                    walletUpload.style.display = 'block';
                } else {
                    walletInfo.style.display = 'none';
                    walletUpload.style.display = 'none';
                }
            }

            paymentCash.addEventListener('change', toggleWallet);
            paymentWallet.addEventListener('change', toggleWallet);
            toggleWallet();

            const checkoutForm = document.getElementById('checkout-form');
            checkoutForm.addEventListener('submit', (e) => {
                e.preventDefault();
                formErrors.textContent = '';

                const email = emailInput.value.trim();
                const phone = document.getElementById('phone').value.trim();
                const fullname = document.getElementById('fullname').value.trim();
                const address = document.getElementById('address').value.trim();

                if (!email || !phone || !fullname || !address) {
                    formErrors.textContent = 'Please fill in all required fields.';
                    return;
                }

                if (paymentWallet.checked) {
                    const walletReceiptInput = document.getElementById('wallet-receipt');
                    if (!walletReceiptInput.files || walletReceiptInput.files.length === 0) {
                        formErrors.textContent = `Please transfer to ${walletNumber.textContent} and upload the receipt.`;
                        walletReceiptInput.focus();
                        return;
                    }
                }

                const shippingFee = parseFloat(shippingEl.textContent.replace('$', '')) || 0;
                const total = parseFloat(totalEl.textContent.replace('$', '')) || 0;

                const orderData = {
                    user_id: LuxeApp.state.user.id,
                    email,
                    phone,
                    fullname,
                    address,
                    cart: LuxeApp.state.cart,
                    shippingFee,
                    total,
                    paymentMethod: paymentWallet.checked ? 'wallet' : 'cash',
                    walletReceipt: paymentWallet.checked ? walletReceiptInput.files[0] : null
                };

                LuxeApp.placeOrder(orderData);

            });
        });
    </script>

</body>

</html>